<html>
    <head>
        <title>Keyboard Shortcut configuration</title>
        <script src="jquery-3.3.1.min.js"></script>
        <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
        <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
        <script src="underscore-min.js"></script>
        <script src="Keycode.js"></script>
        <script src="EventConfig.js"></script>
        <script src="EventTriggerer.js"></script>
        <style>
        table{
            border: 2px solid black;
        }
        tr{
            height: 30px;
        }
        td {
            border: 1px solid blanchedalmond;
        }
        thead{
            background-color: lightgrey;
        }
        input{
            padding-left: 5px;
            height: 30px;
        }
        </style>
    </head>
    <body>
        <div id = "eventName" style="font-size: 24px">
            <div style="color: darkgreen;">
                Hit Shift+Alt and reconfigure shortcuts.
            </div>
            <br/>
            <div  style="color: crimson;">
                Please don't assign duplicate keys.
            </div>
        </div>
        <div id="configPopUp" title="Configure shortcut keys (Hit Esc to close)" style="display: none;"></div>

    </body>
    <script>
        $(document).ready(function(){
            configureEvents();
            $(document).on("moveup", function(){
                $("#eventName").text("Move up triggered");
            });
            $(document).on("movedown", function(){
                $("#eventName").text("Move down triggered");
            });
            $(document).on("setupShortcut", function(e){
                var configCollection = getConfigCollection();
                var tableEle = "";
                _.each(configCollection, function(config){
                   var key1 =  _.findKey(KEYCODES, function(code){
                        return code == config.key1;
                    });
                    var key2 = _.findKey(KEYCODES, function(code){
                        return code == config.key2;
                    });
                    var combination = (key1 ? key1 : "") + (key2 ? "+" + key2 : "");
                    tableEle = tableEle + "<tr> <td><b>"+ config.description + ":</b> </td><td> <input class = 'keys-input' id = '"+config.name+"'type = 'text' placeholder = 'Press Key of your choice' value = '"+ combination +"' /></td></tr>"
                });
                var format = "<table><thead><tr><td><b>Shortcut Description</b></td><td><b>Key Combination</b></td></tr></thead><tbody>"+ tableEle +"</tbody></table>"
                $("#configPopUp").empty();
                $("#configPopUp").append(format);
                $( "#configPopUp" ).dialog({
                    resizable: true,
                    height: "auto",
                    width: "auto",
                    modal: true,
                    // buttons: {
                    //     "Save (No need : Actions automatically saved)": function() {
                    //     $( this ).dialog( "close" );
                    //     }
                    // }
                });
                var modal = document.getElementById('configPopUp');
	            var x = e.clientX, y = e.clientY;
                modal.style.display = "block";
            });
            $(document).on("changeKey", function(event, data){
                var key2;
                var key1 =  _.findKey(KEYCODES, function(code){
                        return code == data.latestKey.toString();
                    });
                if(data.pressedKey != data.latestKey){
                    key2 = _.findKey(KEYCODES, function(code){
                        return code == data.pressedKey.toString();
                    });
                }
                var combination = (key2 ? key2 + "+" : "") + (key1 ? key1 : "");
                console.log(combination);
                if(document.activeElement.className === "keys-input"){
                    var id = document.activeElement.id;
                    var configCollection = getConfigCollection();
                    var index = _.findIndex(configCollection, function(config){
                        return config.name === id;
                    });
                    var newKey1 = data.pressedKey.toString();;
                    var newKey2 = data.pressedKey === data.latestKey ? undefined : data.latestKey.toString();;
                    var duplicateIndex = _.findIndex(configCollection, function(config){
                        return config.key1 === newKey1 && config.key2 === newKey2 && config.name != id;
                    });
                    $(document.activeElement).val(combination);
                    if(duplicateIndex != -1 ){
                        $(document.activeElement).css('background', 'red');
                        return;
                    }
                    $(document.activeElement).css('background', 'white');
                    configCollection[index].key1 = newKey1;
                    configCollection[index].key2 = newKey2;
                }
            })
        })

    </script>
</html>